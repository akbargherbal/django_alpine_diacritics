{% extends 'project_manager/base.html' %}
{% load static %}

{% block custom_stylesheets %}
<link rel="stylesheet" href="{% static 'project_manager/css/project_manager.css' %}"/>
<link rel="stylesheet" href="{% static 'project_manager/css/diacriticize.css' %}"/>
{% endblock %}

{% block content %}
<div class="pm-container">
    <div class="pm-header">
        <div>
            <h1 class="pm-title">Verse {{ verse.position }}</h1>
            <p class="pm-card-meta">
                Project: {{ verse.document.project.name }} • 
                Document: {{ verse.document.name }}
            </p>
        </div>
        <a href="{% url 'project_manager:document_detail' verse.document.pk %}" 
           class="pm-btn pm-btn-secondary">
            Back to Document
        </a>
    </div>

    {# Diacriticizer Component Integration #}
    <div class="pm-card">
        <div id="text-content" class="text-content-wrapper">
            <div class="verse" 
                 data-tokens-count="{{ tokens_count }}"
                 data-dia-count="{{ total_diacritics }}"
                 data-mode="{{ mode }}">
                {{ verse_html|safe }}
            </div>

            {# Hidden JSON data #}
            {{ wd_dict|json_script:"wd_dict" }}
            {{ char_dict_global|json_script:"char_dict_global" }}
            {{ char_dict_local|json_script:"char_dict_local" }}
        </div>

        {# Mode and Controls #}
        <div class="control-panel">
            <div class="mode-indicator">
                <span>Current Mode:</span>
                <span class="mode-display" x-text="isEditMode ? 'Edit Mode' : (isAutoPilot ? 'Auto-pilot' : 'Normal')"></span>
            </div>
        </div>

        {# Stats Display #}
        <div class="stats-panel">
            <div class="diacritic-display">
                <span>الحركة: </span>
                <span x-text="currentChar"></span>
            </div>
        </div>
    </div>
    
    {# Status Update Section #}
    <div class="pm-card" style="margin-top: 1rem;">
        <div class="pm-card-meta" style="text-align: center;">
            <p>Current Status: <span id="current-status">{{ verse.get_status_display }}</span></p>
            
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                {% for status_value, status_label in verse.Status.choices %}
                    <button class="pm-btn {% if verse.status == status_value %}pm-btn-primary{% else %}pm-btn-secondary{% endif %}"
                            hx-post="{% url 'project_manager:update_verse_status' verse.pk %}"
                            hx-vals='{"status": "{{ status_value }}"}'
                            hx-target="#current-status"
                            hx-swap="innerHTML">
                        {{ status_label }}
                    </button>
                {% endfor %}
            </div>
        </div>
    </div>

    {# Keyboard Shortcuts Guide #}
    <div class="pm-card" style="margin-top: 1rem;">
        <h2 class="pm-card-title">Keyboard Shortcuts</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <h3>Navigation</h3>
                <ul>
                    <li>Enter - Toggle Edit Mode</li>
                    <li>Escape - Exit Edit Mode</li>
                    <li>Ctrl + Space - Next Word</li>
                    <li>Space - Next Character</li>
                    <li>Ctrl + A - Toggle Auto-pilot Mode</li>
                </ul>
            </div>
            <div>
                <h3>Diacritics</h3>
                <ul>
                    <li>1 - Fatha (َ)</li>
                    <li>2 - Kasra (ِ)</li>
                    <li>3 - Damma (ُ)</li>
                    <li>4 - Tanwin Fatha (ً)</li>
                    <li>5 - Tanwin Kasra (ٍ)</li>
                    <li>6 - Tanwin Damma (ٌ)</li>
                    <li>9 - Shadda (ّ)</li>
                    <li>0 - Sukun (ْ)</li>
                </ul>
            </div>
            <div>
                <h3>Shadda Combinations</h3>
                <ul>
                    <li>Ctrl + 1 - Shadda with Fatha (َّ)</li>
                    <li>Ctrl + 2 - Shadda with Kasra (ِّ)</li>
                    <li>Ctrl + 3 - Shadda with Damma (ُّ)</li>
                    <li>Ctrl + 4 - Shadda with Tanwin Fatha (ًّ)</li>
                    <li>Ctrl + 5 - Shadda with Tanwin Kasra (ٍّ)</li>
                    <li>Ctrl + 6 - Shadda with Tanwin Damma (ٌّ)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_scripts %}
<script>
    // Initialize Alpine component on load
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('text-content');
        if (container) {
            container.setAttribute('x-data', 'sentHook');
            container.setAttribute('tabindex', '0');
            container.setAttribute(':class', "{'edit-mode': isEditMode, 'autopilot-mode': isAutoPilot}");
        }
    });
</script>
{% endblock %}